#!/usr/bin/env bash

root="$HOME"/.local/state/tasks/
mkdir -p "$root/todo"
mkdir -p "$root/done"

cd "$root" || exit 1

die() {
  echo "$*" >&2
  exit 1
}

get-file-time() {
  local epoch; epoch="$( basename "${1%.txt}" )"
  date -d "@$epoch" '+%m-%d'
}

get-todos() {
  find todo/ -type f | sort
}

get-dones() {
  find done/ -type f | sort
}

get-todo-by-index() {
  local index="$1"
  local n=0

  while read -r f; do
    (( ++n == index )) && { echo "$f"; break; }
  done < <( get-todos )
}

c() {
  printf '% 4d/% 4d\n' \
    "$( get-todos | wc -l )" \
    "$( get-dones | wc -l )"
}

l() {
  local n=0

  while read -r f; do
    (( n++ ))
    read -r line < "$f"
    printf '%3d %s  %s\n' \
      "$n" \
      "$( get-file-time "$f" )" \
      "$line"

  done < <( get-todos )
}

p() {
  local limit="${1:-10}"

  while read -r f; do
    read -r line < "$f"
    printf 'done: %s %s\n' \
      "$( get-file-time "$f" )" \
      "$line"

  done < <( get-dones | tail -n "$limit" )
}

a() {
  echo "$*" > "todo/$( date '+%s' ).txt"
}

d(){
  local fs=()
  while [[ $1 ]]; do
    local f; f="$( get-todo-by-index "$1" )"
    [[ "$f" ]] || die "No such task: $index"
    fs+=( "$f" )
    shift
  done

  for f in "${fs[@]}"; do
    read -r line < "$f"
    mv "$f" "done/"
    echo "done: $line"
  done
}

e() {
  local index="$1"
  local f; f="$( get-todo-by-index "$index" )"
  [[ "$f" ]] || die "No such task: $index"

  shift
  [[ "$*" ]] || die "No new task description provided"
  echo "$*" > "$f"
}

"${@:-l}"
