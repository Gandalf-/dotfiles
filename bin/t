#!/usr/bin/env bash

root="$HOME"/.local/state/tasks/
mkdir -p "$root/todo"
mkdir -p "$root/done"

cd "$root" || exit 1

die() {
  echo "$*" >&2
  exit 1
}

get-file-time() {
  local epoch; epoch="$( basename "${1%.txt}" )"
  date -d "@$epoch" '+%m-%d'
}

get-todos() {
  find todo/ -type f | sort
}

get-dones() {
  find done/ -type f | sort -r
}

by-index() {
  local index="$1"
  local n=0

  while read -r f; do
    (( ++n == index )) && { echo "$f"; break; }
  done
}

listing() {
  local n=0
  local limit="${1:-10}"

  while read -r f; do
    (( n++ ))
    read -r line < "$f"
    printf '%3d %s %s\n' \
      "$n" \
      "$( get-file-time "$f" )" \
      "$line"

  done < <( cat | head -n "$limit" )
}

h() {
  cat << EOF
Usage: t [command] [args...]
Commands:
  a [desc]         Add a new task
  d [index ...]    Mark todo tasks as done by index
  u [index ...]    Mark done tasks as todo by index
  l                List all tasks

  e [index] [desc] Rewrite a task by index
  p [limit]        List recently done tasks
  c                Show summary counts
  h                Show this help message
EOF
}

c() {
  printf '% 4d/% 4d\n' \
    "$( get-todos | wc -l )" \
    "$( get-dones | wc -l )"
}

l() {
  get-todos | listing 100
}

p() {
  get-dones | listing "$@"
}

a() {
  [[ "$*" ]] || die "No task description provided"
  echo "$*" > "todo/$( date '+%s' ).txt"
}

d(){
  local fs=()
  while [[ $1 ]]; do
    local f; f="$( get-todos | by-index "$1" )"
    [[ "$f" ]] || die "No such task: $1"
    fs+=( "$f" )
    shift
  done

  for f in "${fs[@]}"; do
    read -r line < "$f"
    mv "$f" "done/"
    echo "done: $line"
  done
}

u() {
  local fs=()
  while [[ $1 ]]; do
    local f; f="$( get-dones | by-index "$1" )"
    [[ "$f" ]] || die "No such task: $1"
    fs+=( "$f" )
    shift
  done

  for f in "${fs[@]}"; do
    read -r line < "$f"
    mv "$f" "todo/"
    echo "todo: $line"
  done
}

e() {
  local index="$1"
  local f; f="$( get-todos | by-index "$index" )"
  [[ "$f" ]] || die "No such task: $index"

  shift
  [[ "$*" ]] || die "No new task description provided"
  echo "$*" > "$f"
}

"${@:-l}"
